# 1，检查光猫

看看家里的光猫（网关）有没有公网IP。

最好要有IPv6的。

- IPv6
  - 八组十六进制数，每组4位，用 : 分割。
  - 以下就是公网地址：
    - 第一组数的第一位是2或3。

# 2，看路由器

既然光猫有公网地址，那路由器应该也会有。

跟随光猫的IPv6前缀的内网IPv6地址。

# 3，看设备

如 windows 在命令行中输入 ipconfig 检查一下。

要永久IPv6地址，前面有个临时字眼的就不要用。

且就算是永久地址，也要确保路由器，光猫，设备等都不要换。

只要任何一个换了这个地址都会变。

这个永久地址其实也就是路由器从光猫获取的地址前缀，结合设备MAC（设备物理标识）组出来的地址。

# 4，买域名

买个域名回来，有钱就行，没啥技术含量。

# 5，加入解析

把设备的IPv6地址加入域名解析。

要选AAAA类型，IPv6专用。

一个地址加两条解析，一个www，一个@。

为了确保www.xxx.com和xxx.com都能访问。

# 6，端口放行

把设备的80和443端口放开。

```bash
netsh advfirewall firewall add rule name="Allow HTTP 80" dir=in action=allow protocol=TCP localport=80
```

```bash
netsh advfirewall firewall add rule name="Allow HTTPS 443" dir=in action=allow protocol=TCP localport=443
```

```bash
netsh advfirewall firewall show rule name=all | findstr 443
```

# 7，配置Caddy

下载caddy，应该就是一个exe，丢在某个地方不要再动它。

同级创建一个Caddyfile文件，一定要文件类型，不要有后缀的那种。

往这个文件里写Caddy的配置就行。

```
买来的域名.xxx {
    respond "Hello from IPv6 Caddy"
}
```

# 8，启动Caddy

然后原地打开命令行跑命令。

```bash
caddy_windows_amd64.exe run --config Caddyfile
```

只要域名解析生效，Caddy理应会自动尝试申请证书。

# 9，检查访问

然后拿台手机啥的，确保是公网，比如断wifi开流量，访问域名，理应会输出Caddy中的信息。

# TP

## 1，ACME效验失败

ACME（自动证书管理环境）是一种网络协议，用于自动化申请，续订和吊销SSL/TLS证书。

这里就是让Caddy使用ACME代管证书的管理。

- 原因
  - 域名解析给了光猫的IPv6地址。
  - 但Caddy所在实际设备地址是经过路由器合并光猫地址作为前缀拼出来的。
  - 所以光是根据光猫地址是找不到Caddy所在的。
  - 所以ACME申请不到证书。
- 解决
  - 把域名解析的地址换成设备的IPv6地址即可。
  - 因为这是从公网到光猫过路由器指向实际设备的完整地址。
  - 证书可以顺利申请并返回。

## 2，域名拨测无效

如阿里巴巴的域名拨测服务，专门用来检测域名的可用性。

是否能被DNS（域名服务器）解析，是否能收到返回响应。

- 原因
  - 没有实际应用的，仅有Caddy返回一句简单文本的情况下。
  - 域名拨测可能因为缺少完整响应的结构而当作无法响应。
  - 又或因为刚加入的域名解析条目还没有被全球DNS（域名服务器）识别并解析。
  - 就是还没来得及生效。
  - 所以没用。
- 解决
  - 加入新的域名解析条目后等几分钟，最保险就是等几个小时。
  - 让全球DNS（域名服务器）全部生效。
  - 并以Caddy的证书申请响应与域名实际访问情况为准。
  - 域名拨测仅供参考。

## 3，访问无效

包括证书申请失败，域名拨测无效，访问域名失败等。

- 原因
  - 尤其在第一步，连证书都申请不下来时。
  - IP确认为公网可用。
  - 就极有可能是设备或路由防火墙给拦住了或是地址给成临时地址。
- 解决
  - 检查一下放行规则。
  - 或干脆直接输命令放行80和443端口。
  - 80用于http，443用于https。
  - 再检查给的地址是不是设备的，且不是临时的。
  - 最难绷就是看看是不是设备地址直接变了。



