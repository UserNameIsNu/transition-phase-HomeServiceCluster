[TOC]



# 1，背景与目标

## 1.要干嘛的

丢在家庭网络下的服务集群。

在不依赖云厂商的前提下，通过公网IPv6地址与买来的域名，实现集群部署。

## 2.为啥不用现成的

云厂商太™贵了。

可怜的双核4G配个位数MB的环境要每月几百。

尤其想扩数据传输量，更是单独收费，贵的吓人。

要是换用内网穿透，也是单独收费。

反正都是要钱如催命。

在家折腾一个集群，用家里光猫现成的公网地址，家里套餐自带的带宽，自己的电脑。

便宜好几倍，又方便。

尤其公司只能干某一块的活，我这相当于一个人负责整个项目全流程的设计与构建。

可以不做，不熟。

但至少要知道分工咋分，各自干嘛，什么东西必须要，什么东西没必要。

就当作为对微服务架构、网络部署与系统设计的实践与学习。

在学校敲xx系统或进公司curd都学不到这些的。

## 3.目标成啥样

丢自己项目上去展示。

丢自己项目上去自用。

方便管理电脑膨胀的没边的文件。

就是包括Web应用，文件存储，AI服务，身份认证，日志监控等多个独立服务。

类似简化微服务架构。

# 2，设计原则

## 1.服务独立部署

就是使劲拆。

把单体复杂系统干成多个独立，单独启动，单独崩溃，单独修改的形式。

不拆？

改点啥全部重启，不知道牵扯到啥玩意，所有东西绑死。

小项目还好，大起来就是纯纯堆史山。

目前就按照不同的Web应用，服务进行拆分。

Web应用和服务里面爱拆不拆，每个玩意大不到哪里去。

要拆也行，这不有微服务这个老大哥做现成的参考嘛。

## 2.入口统一，内部解耦

对外只有一个入口，就像整体。

内部就是一大帮子小家伙各干各的，分工合作。

免得每个家伙都要独立管理域名，证书，安全，监控啥的。

公网只认caddy，服务只靠端口在内部交流。

## 3.协议优先于实现

就是一开始设计就绕着全部独立，靠http之类的交流。

定义接口，请求格式，返回结构啥的。

只认这套沟通协议，不管项目或服务自身是啥语言写的。

## 4.本地优先，公网可达

集群在自己的私人设备中运行。

数据也在本地。

公网是访问方式，不是生存条件。

断网，炸域名啥的都不影响。

## 5.自动化优于人工配置

能自动化，能配置的就不要人工手动折腾。

如证书管理和内网转发交给caddy。

项目某些属性使用配置值而不要写死在文件中。

## 6.数据访问限制

1. 应用层不可直接访问数据层，必须经由服务层的访问服务。
2. 应用层调用服务时仅允许基础单表操作，禁止复杂或跨表操作。
3. 服务层任何服务在需要访问数据层时均直连，不能出现服务调用服务。
4. 服务层直连时允许任意操作。
5. 应用层需要复杂操作时，拆分为多次简单操作，在应用层拼接使用。
6. 服务层不能返回空，就算是没有结果甚至报错也必须封装进统一响应对象中返回。
7. 应用层拼装的结果之能用于自身业务，不能将拼装结果作为参数反向写回访问服务。

# 3，图

## 1.网络拓扑

![网络拓扑图](.\网络拓扑图.png)

## 2.服务架构

![服务架构图](.\服务架构图.png)

# 4，服务设计